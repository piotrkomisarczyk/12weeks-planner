---
/**
 * Day Planning View Page
 * Route: /plans/[id]/week/[weekNumber]/day/[dayNumber]
 * 
 * Allows users to plan their day with priority-based task slots
 * Server-side: Fetches plan data for context and validation
 * Client-side: React island for interactive day planning
 */

import { PlanService } from '@/lib/services/plan.service';
import { DEFAULT_USER_ID } from '@/db/supabase.client';
import Layout from '@/layouts/Layout.astro';
import { DayPageContainer } from '@/components/plans/day';
import { Toaster } from '@/components/ui/sonner';

export const prerender = false;

// Get params from URL
const { id: planId, weekNumber: weekNumberParam, dayNumber: dayNumberParam } = Astro.params;

// Validate params
if (!planId) {
  return Astro.redirect('/plans');
}

const weekNumber = parseInt(weekNumberParam || '1', 10);
const dayNumber = parseInt(dayNumberParam || '1', 10);

// Validate week number (1-12)
if (isNaN(weekNumber) || weekNumber < 1 || weekNumber > 12) {
  return Astro.redirect(`/plans/${planId}/week/1`);
}

// Validate day number (1-7, Monday=1)
if (isNaN(dayNumber) || dayNumber < 1 || dayNumber > 7) {
  return Astro.redirect(`/plans/${planId}/week/${weekNumber}/day/1`);
}

// Fetch plan data on server
const userId = DEFAULT_USER_ID;
const planService = new PlanService(Astro.locals.supabase);

let plan;
try {
  plan = await planService.getPlanById(planId, userId);
} catch (error) {
  console.error('Error fetching plan:', error);
}

// Redirect if plan not found
if (!plan) {
  return Astro.redirect('/plans');
}

// Check if plan is archived - don't allow editing archived plans
if (plan.status === 'archived') {
  return Astro.redirect(`/plans/${planId}/goals`);
}

// Parse start date
const startDate = new Date(plan.start_date);

// Calculate end date (12 weeks from start)
const endDate = new Date(startDate);
endDate.setDate(startDate.getDate() + (12 * 7) - 1);

// Check if the requested week/day is valid based on plan dates
const currentDate = new Date();
const dayDate = new Date(startDate);
dayDate.setDate(dayDate.getDate() + (weekNumber - 1) * 7 + (dayNumber - 1));

// If day is beyond plan end date, redirect to last day of plan
if (dayDate > endDate) {
  return Astro.redirect(`/plans/${planId}/week/12/day/7`);
}


// Compute display date for the day
const displayDate = dayDate.toLocaleDateString('en-US', { 
  weekday: 'long', 
  year: 'numeric', 
  month: 'long', 
  day: 'numeric' 
});
---

<Layout title={`${plan.name} - Week ${weekNumber} Day ${dayNumber}`}>
  <div class="min-h-screen bg-background">
    <DayPageContainer
      client:load
      planId={planId}
      planName={plan.name}
      planStartDate={startDate}
      weekNumber={weekNumber}
      dayNumber={dayNumber}
    />
    <Toaster client:load position="bottom-right" />
  </div>
</Layout>

