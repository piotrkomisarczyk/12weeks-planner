---
/**
 * Weekly Review Page
 * /plans/[id]/review/[weekNumber]
 *
 * Server-side rendered page for weekly review functionality.
 * Loads initial data (weekly review and goals) and passes to WeeklyReviewContainer.
 */


import Layout from '@/layouts/Layout.astro';
import WeeklyReviewContainer from '@/components/plans/review/WeeklyReviewContainer.tsx';
import { WeeklyReviewService } from '@/lib/services/weekly-review.service';
import { GoalService } from '@/lib/services/goal.service';
import { DEFAULT_USER_ID } from '@/db/supabase.client';
import type {
  WeeklyReviewViewModel,
  GoalReviewViewModel
} from '@/types';

// ============================================================================
// DATA LOADING (SSR)
// ============================================================================

// Extract and validate route parameters
const { id: planId, weekNumber: weekNumberParam } = Astro.params;

// Validate week number
const weekNumber = parseInt(weekNumberParam);
if (isNaN(weekNumber) || weekNumber < 1 || weekNumber > 12) {
  throw new Error(`Invalid week number: ${weekNumberParam}. Must be between 1 and 12.`);
}

// Get Supabase client from Astro context
const supabase = Astro.locals.supabase;
if (!supabase) {
  throw new Error('Supabase client not available');
}

// Initialize services
const weeklyReviewService = new WeeklyReviewService(supabase);
const goalService = new GoalService(supabase);

// Load data from API
let weeklyReview: WeeklyReviewViewModel;
let goals: GoalReviewViewModel[];

try {
  // Load weekly review (may not exist - lazy creation)
  const reviewData = await weeklyReviewService.getWeeklyReviewByWeek(
    planId,
    weekNumber,
    DEFAULT_USER_ID
  );

  // Convert to ViewModel (handle null case for lazy creation)
  weeklyReview = reviewData ? {
    ...reviewData,
    isSaving: false,
    lastSavedAt: null
  } : {
    id: null,
    plan_id: planId,
    week_number: weekNumber,
    what_worked: '',
    what_did_not_work: '',
    what_to_improve: '',
    is_completed: false,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
    isSaving: false,
    lastSavedAt: null
  };

  // Load goals for the plan
  const goalsData = await goalService.getGoalsByPlanId(planId, DEFAULT_USER_ID);

  goals = goalsData.map(goal => ({
    ...goal,
    isUpdating: false
  }));

} catch (error) {
  console.error('Error loading weekly review data:', error);

  // Handle plan not found or access denied
  if (error.message?.includes('not found') || error.message?.includes('does not belong')) {
    throw new Error(`Plan with ID ${planId} not found or access denied`);
  }

  // Re-throw other errors
  throw error;
}

// ============================================================================
// PAGE RENDER
// ============================================================================
---

<Layout title={`Weekly Review - Week ${weekNumber}`}>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <WeeklyReviewContainer
      client:load
      planId={planId}
      weekNumber={weekNumber}
      initialReview={weeklyReview}
      initialGoals={goals}
    />
  </div>
</Layout>