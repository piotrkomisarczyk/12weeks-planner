---
/**
 * Home page with smart redirect logic (US-002)
 * - If user has active planner -> redirect to dashboard
 * - If no active planner -> redirect to planners list
 */

const { user, supabase } = Astro.locals;

// User must be authenticated (middleware ensures this)
if (!user) {
  return Astro.redirect("/login");
}

// Check if user has an active planner
try {
  const { data: activePlan } = await supabase
    .from("plans")
    .select("id")
    .eq("user_id", user.id)
    .eq("status", "active")
    .single();

  if (activePlan) {
    // User has active planner - redirect to its dashboard
    return Astro.redirect(`/plans/${activePlan.id}`);
  } else {
    // No active planner - redirect to planners list
    return Astro.redirect("/plans");
  }
} catch (error) {
  console.error("Error checking active plan:", error);
  // On error, default to planners list
  return Astro.redirect("/plans");
}
---
