---
import "../styles/global.css";
import type { PlanSummary, PlanStatus } from "@/types";
import { createServerClient } from "@supabase/ssr";
import { PlanService } from "@/lib/services/plan.service";
import TopNavigation from "@/components/navigation/TopNavigation.astro";
import { Toaster } from "@/components/ui/sonner";

interface Props {
  title?: string;
}

const { title = "12 Weeks Planner" } = Astro.props;

// Initialize Supabase server client
const supabase = createServerClient(import.meta.env.SUPABASE_URL, import.meta.env.SUPABASE_KEY, {
  cookies: {
    get(key) {
      return Astro.cookies.get(key)?.value;
    },
    set(key, value, options) {
      Astro.cookies.set(key, value, options);
    },
    remove(key, options) {
      Astro.cookies.delete(key, options);
    },
  },
});

// Get current user - middleware should have already verified authentication
const {
  data: { user },
} = await supabase.auth.getUser();
const userId = user?.id;

// Extract plan ID from URL if we're in a plan context
const urlParts = Astro.url.pathname.split("/").filter(Boolean);
let plan: PlanSummary | null = null;

// Check if we're on a plan-specific page: /plans/[id]/...
if (userId && urlParts[0] === "plans" && urlParts.length >= 2 && urlParts[1].match(/^[a-f0-9-]{36}$/i)) {
  const planId = urlParts[1];

  try {
    const planService = new PlanService(supabase);
    const fullPlan = await planService.getPlanById(planId, userId);

    if (fullPlan) {
      // Create a minimal PlanSummary for navigation
      plan = {
        id: fullPlan.id,
        name: fullPlan.name,
        start_date: fullPlan.start_date,
        status: fullPlan.status as PlanStatus,
      };
    }
  } catch (error) {
    // Continue without plan data - TopNavigation will handle null plan
  }
}

const userEmail = user?.email || "dev@example.com";
---

<!doctype html>
<html lang="en" class="bg-background">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />
    <script is:inline>
      (() => {
        try {
          const stored = localStorage.getItem("theme");
          const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          const shouldUseDark = stored === "dark" || (!stored && prefersDark);
          document.documentElement.classList.toggle("dark", shouldUseDark);
          document.documentElement.style.colorScheme = shouldUseDark ? "dark" : "light";
        } catch {
          // If localStorage is unavailable, fall back to CSS defaults.
        }
      })();
    </script>
    <title>{title}</title>
  </head>
  <body class="bg-background text-foreground">
    <TopNavigation plan={plan} userEmail={userEmail} />
    <main class="min-h-screen bg-background">
      <slot />
    </main>
    <Toaster client:load />
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
