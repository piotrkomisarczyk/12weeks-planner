---
/**
 * Weekly Review Page
 * /plans/[id]/review/[weekNumber]
 *
 * Server-side rendered page for weekly review functionality.
 * Loads initial data (weekly review and goals) and passes to WeeklyReviewContainer.
 */

import Layout from "@/layouts/Layout.astro";
import WeeklyReviewContainer from "@/components/plans/review/WeeklyReviewContainer.tsx";
import { WeeklyReviewService } from "@/lib/services/weekly-review.service";
import { GoalService } from "@/lib/services/goal.service";
import { PlanService } from "@/lib/services/plan.service";
import type { WeeklyReviewViewModel, GoalReviewViewModel, PlanStatus } from "@/types";

// ============================================================================
// DATA LOADING (SSR)
// ============================================================================

// Extract and validate route parameters
const { id: planId, weekNumber: weekNumberParam } = Astro.params;

// Validate params
if (!planId) {
  return Astro.redirect("/plans");
}

const weekNumber = parseInt(weekNumberParam || "1", 10);

// Validate week number (1-12)
if (isNaN(weekNumber) || weekNumber < 1 || weekNumber > 12) {
  return Astro.redirect(`/plans/${planId}/review/1`);
}

// Get user session (middleware handles authentication)
const userId = Astro.locals.user?.id;

if (!userId) {
  return Astro.redirect("/login");
}

// Get Supabase client from Astro context
const supabase = Astro.locals.supabase;
if (!supabase) {
  throw new Error("Supabase client not available");
}

// Initialize services
const weeklyReviewService = new WeeklyReviewService(supabase);
const goalService = new GoalService(supabase);
const planService = new PlanService(supabase);

// Load data from API
let plan;
let weeklyReview: WeeklyReviewViewModel;
let goals: GoalReviewViewModel[];

try {
  // Load plan data
  plan = await planService.getPlanById(planId, userId);

  // Load weekly review (may not exist - lazy creation)
  const reviewData = await weeklyReviewService.getWeeklyReviewByWeek(planId, weekNumber, userId);

  // Convert to ViewModel (handle null case for lazy creation)
  weeklyReview = reviewData
    ? {
        ...reviewData,
        isSaving: false,
        lastSavedAt: null,
      }
    : {
        id: null,
        plan_id: planId,
        week_number: weekNumber,
        what_worked: "",
        what_did_not_work: "",
        what_to_improve: "",
        is_completed: false,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        isSaving: false,
        lastSavedAt: null,
      };

  // Load goals for the plan with milestones
  const goalsData = await goalService.getGoalsByPlanId(planId, userId);

  // Fetch milestones for each goal
  const goalsWithMilestones = await Promise.all(
    goalsData.map(async (goal) => {
      const goalWithMilestones = await goalService.getGoalWithMilestones(goal.id, userId);
      return {
        ...goal,
        isUpdating: false,
        milestones: goalWithMilestones?.milestones || [],
      };
    })
  );

  goals = goalsWithMilestones;
} catch (error) {
  console.error("Error loading weekly review data:", error);

  // Handle plan not found or access denied
  if (error instanceof Error && (error.message?.includes("not found") || error.message?.includes("does not belong"))) {
    throw new Error(`Plan with ID ${planId} not found or access denied`);
  }

  // Re-throw other errors
  throw error;
}

// ============================================================================
// PAGE RENDER
// ============================================================================

// Ensure plan exists
if (!plan) {
  throw new Error(`Plan with ID ${planId} not found or access denied`);
}
---

<Layout title={`Weekly Review - Week ${weekNumber}`}>
  <div class="min-h-screen bg-background">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
      <WeeklyReviewContainer
        client:load
        planId={planId}
        weekNumber={weekNumber}
        initialReview={weeklyReview}
        initialGoals={goals}
        planStatus={plan.status as PlanStatus}
      />
    </div>
  </div>
</Layout>
