---
/**
 * Day Planning View Page
 * Route: /plans/[id]/week/[weekNumber]/day/[dayNumber]
 *
 * Allows users to plan their day with priority-based task slots
 * Server-side: Fetches plan data for context and validation
 * Client-side: React island for interactive day planning
 */

import { PlanService } from "@/lib/services/plan.service";
import Layout from "@/layouts/Layout.astro";
import { DayPageContainer } from "@/components/plans/day";
import { Toaster } from "@/components/ui/sonner";
import { getMondayOffset } from "@/lib/utils";
import type { PlanStatus } from "@/types";

export const prerender = false;

// Get params from URL
const { id: planId, weekNumber: weekNumberParam, dayNumber: dayNumberParam } = Astro.params;

// Validate params
if (!planId) {
  return Astro.redirect("/plans");
}

const weekNumber = parseInt(weekNumberParam || "1", 10);
const dayNumber = parseInt(dayNumberParam || "1", 10);

// Validate week number (1-12)
if (isNaN(weekNumber) || weekNumber < 1 || weekNumber > 12) {
  return Astro.redirect(`/plans/${planId}/week/1`);
}

// Validate day number (1-7, Monday=1)
if (isNaN(dayNumber) || dayNumber < 1 || dayNumber > 7) {
  return Astro.redirect(`/plans/${planId}/week/${weekNumber}/day/1`);
}

// Get user session (middleware handles authentication)
const userId = Astro.locals.user?.id;

if (!userId) {
  return Astro.redirect("/login");
}

// Fetch plan data on server
const planService = new PlanService(Astro.locals.supabase);

let plan;
try {
  plan = await planService.getPlanById(planId, userId);
} catch (error) {
}

// Redirect if plan not found
if (!plan) {
  return Astro.redirect("/plans");
}

// Parse start date - use timezone-safe parsing by splitting the date string
const [year, month, day] = plan.start_date.split("-").map(Number);
const startDate = new Date(year, month - 1, day);

// Calculate week start date (Monday of the week containing plan start)
const weekStartDate = new Date(startDate);
const mondayOffset = getMondayOffset(weekStartDate);
weekStartDate.setDate(weekStartDate.getDate() + mondayOffset);

// Calculate end date (12 weeks from week start)
const endDate = new Date(weekStartDate);
endDate.setDate(weekStartDate.getDate() + 12 * 7 - 1);

// Check if the requested week/day is valid based on plan dates
const dayDate = new Date(weekStartDate);
dayDate.setDate(dayDate.getDate() + (weekNumber - 1) * 7 + (dayNumber - 1));

// If day is beyond plan end date, redirect to last day of plan
if (dayDate > endDate) {
  return Astro.redirect(`/plans/${planId}/week/12/day/7`);
}
---

<Layout title={`${plan.name} - Week ${weekNumber} Day ${dayNumber}`}>
  <div class="min-h-screen bg-background">
    <DayPageContainer
      client:load
      planId={planId}
      planName={plan.name}
      planStartDate={startDate}
      weekNumber={weekNumber}
      dayNumber={dayNumber}
      planStatus={plan.status as PlanStatus}
    />
    <Toaster client:load position="bottom-right" />
  </div>
</Layout>
